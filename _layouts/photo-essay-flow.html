---
layout: default
---

<article class="photo-essay-flow" data-photo-essay-flow>
  <header class="photo-essay-flow-header">
    <h1>{{ page.title }}</h1>
    {% if page.subtitle or page.location or page.camera %}
    <div class="photo-essay-flow-metadata">
      {% if page.subtitle %}<span>{{ page.subtitle }}</span>{% endif %}
      {% if page.location %}
        {% if page.subtitle %} · {% endif %}
        <span>{{ page.location }}</span>
      {% endif %}
      {% if page.camera %}
        {% if page.subtitle or page.location %} · {% endif %}
        <span>{{ page.camera }}</span>
      {% endif %}
    </div>
    {% endif %}
    {% if page.date %}
    <time datetime="{{ page.date | date_to_xmlschema }}">{{ page.date | date: "%B %e, %Y" }}</time>
    {% endif %}
  </header>

  <div class="photo-essay-flow-body" data-photo-essay-flow-body>
    {{ content }}
  </div>

  <div class="photo-essay-flow-lightbox" id="photoEssayFlowLightbox" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="photo-essay-flow-lightbox__inner">
      <button type="button" class="photo-essay-flow-lightbox__arrow photo-essay-flow-lightbox__arrow--prev" data-flow-prev aria-label="Previous image">&#10094;</button>
      <img class="photo-essay-flow-lightbox__image" data-flow-image alt="">
      <button type="button" class="photo-essay-flow-lightbox__arrow photo-essay-flow-lightbox__arrow--next" data-flow-next aria-label="Next image">&#10095;</button>
      <button type="button" class="photo-essay-flow-lightbox__close" data-flow-close aria-label="Close">&times;</button>
    </div>
  </div>
</article>

<script>
  (function() {
    var body = document.querySelector('[data-photo-essay-flow-body]');
    if (!body) return;

    var nodes = Array.prototype.slice.call(body.children);
    var ElementCtor = window.HTMLElement || Element;
    var strips = [];
    var currentStrip = null;

    function extractImageSlides(node) {
      if (!node || node.tagName !== 'P') return null;
      var childNodes = Array.prototype.slice.call(node.childNodes);
      var images = [];

      for (var i = 0; i < childNodes.length; i++) {
        var child = childNodes[i];

        if (child.nodeType === 3) {
          if (child.textContent.trim() !== '') {
            return null;
          }
          continue;
        }

        if (child.nodeType === 1) {
          if (child.tagName === 'IMG') {
            images.push(child);
            continue;
          }
          if (child.tagName === 'BR') {
            continue;
          }
        }

        return null;
      }

      if (!images.length) return null;

      if (images.length === 1) {
        node.classList.add('photo-essay-flow-slide');
        return [node];
      }

      var slides = images.map(function(img) {
        var wrapper = document.createElement('p');
        wrapper.className = 'photo-essay-flow-slide';
        wrapper.appendChild(img);
        return wrapper;
      });

      node.remove();
      return slides;
    }

    nodes.forEach(function(node) {
      if (!(node instanceof ElementCtor)) {
        currentStrip = null;
        return;
      }

      if (node.classList.contains('photo-essay-flow-strip-container')) {
        currentStrip = node.querySelector('.photo-essay-flow-strip');
        if (currentStrip) {
          strips.push(currentStrip);
        }
        return;
      }

      var imageSlides = extractImageSlides(node);
      if (imageSlides && imageSlides.length) {
        if (!currentStrip) {
          var container = document.createElement('div');
          container.className = 'photo-essay-flow-strip-container';
          var strip = document.createElement('div');
          strip.className = 'photo-essay-flow-strip';
          container.appendChild(strip);
          body.insertBefore(container, node);
          strips.push(strip);
          currentStrip = strip;
        }
        imageSlides.forEach(function(slide) {
          currentStrip.appendChild(slide);
        });
      } else {
        currentStrip = null;
        if (node.matches('p, h2, h3, h4, h5, h6, blockquote, ul, ol, pre')) {
          node.classList.add('photo-essay-flow-text-block');
        }
      }
    });

    // Remove empty strip containers (e.g., if markdown started with text)
    strips = strips.filter(function(strip) {
      if (!strip.children.length) {
        var parent = strip.parentElement;
        if (parent) parent.remove();
        return false;
      }
      return true;
    });

    if (!strips.length) return;

    // Scroll hint + state setup
    var stripStates = new Map();
    var activeStrip = strips[0];

    function createHint(strip) {
      var container = strip.parentElement;
      if (!container) return;
      var hint = document.createElement('div');
      hint.className = 'photo-essay-flow-scroll-hint';
      hint.textContent = 'Scroll →';
      container.appendChild(hint);

      function hideHint() {
        hint.style.opacity = '0';
        setTimeout(function() {
          if (hint.parentElement) {
            hint.parentElement.removeChild(hint);
          }
        }, 320);
        strip.removeEventListener('scroll', onScroll);
      }

      function onScroll() {
        if (strip.scrollLeft > 16) {
          hideHint();
        }
      }

      strip.addEventListener('scroll', onScroll, { passive: true });
      setTimeout(hideHint, 4500);
    }

    strips.forEach(function(strip) {
      var slides = Array.prototype.slice.call(strip.querySelectorAll('img'));
      var state = { slides: slides, currentIndex: 0, raf: null };
      stripStates.set(strip, state);
      createHint(strip);

      strip.addEventListener('mouseenter', function() {
        activeStrip = strip;
      });
      strip.addEventListener('touchstart', function() {
        activeStrip = strip;
      }, { passive: true });

      strip.addEventListener('scroll', function() {
        if (state.raf) {
          cancelAnimationFrame(state.raf);
        }
        state.raf = requestAnimationFrame(function() {
          state.raf = null;
          syncStripIndex(strip);
        });
      }, { passive: true });
    });

    function syncStripIndex(strip) {
      var state = stripStates.get(strip);
      if (!state || !state.slides.length) return;
      var stripRect = strip.getBoundingClientRect();
      var targetX = stripRect.left + stripRect.width / 2;
      var closest = state.currentIndex;
      var minDelta = Infinity;

      state.slides.forEach(function(img, index) {
        var rect = img.getBoundingClientRect();
        var center = rect.left + rect.width / 2;
        var delta = Math.abs(center - targetX);
        if (delta < minDelta) {
          minDelta = delta;
          closest = index;
        }
      });

      state.currentIndex = closest;
    }

    function scrollStripToIndex(strip, nextIndex) {
      var state = stripStates.get(strip);
      if (!state || !state.slides.length) return;
      var clamped = Math.max(0, Math.min(nextIndex, state.slides.length - 1));
      state.currentIndex = clamped;
      var target = state.slides[clamped];
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }

    // Lightbox setup
    var lightbox = document.getElementById('photoEssayFlowLightbox');
    var lightboxImg = lightbox ? lightbox.querySelector('[data-flow-image]') : null;
    var btnPrev = lightbox ? lightbox.querySelector('[data-flow-prev]') : null;
    var btnNext = lightbox ? lightbox.querySelector('[data-flow-next]') : null;
    var btnClose = lightbox ? lightbox.querySelector('[data-flow-close]') : null;

    var galleryImages = strips.reduce(function(all, strip) {
      var imgs = Array.prototype.slice.call(strip.querySelectorAll('img'));
      return all.concat(imgs);
    }, []);

    var lightboxIndex = 0;
    var lightboxOpen = false;

    function openLightbox(index) {
      if (!lightbox || !lightboxImg || !galleryImages.length) return;
      lightboxIndex = index;
      var img = galleryImages[index];
      if (!img) return;
      lightboxImg.src = img.getAttribute('data-full-src') || img.src;
      lightboxImg.alt = img.alt || '';
      lightbox.classList.add('is-active');
      lightbox.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      lightboxOpen = true;
    }

    function closeLightbox() {
      if (!lightbox) return;
      lightbox.classList.remove('is-active');
      lightbox.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      lightboxOpen = false;
    }

    function showLightbox(delta) {
      if (!galleryImages.length) return;
      lightboxIndex = (lightboxIndex + delta + galleryImages.length) % galleryImages.length;
      openLightbox(lightboxIndex);
    }

    galleryImages.forEach(function(img, index) {
      img.dataset.flowIndex = String(index);
      if (!img.hasAttribute('loading')) {
        img.setAttribute('loading', 'lazy');
      }
      img.addEventListener('click', function(e) {
        e.preventDefault();
        openLightbox(index);
      });
    });

    if (btnPrev) {
      btnPrev.addEventListener('click', function(e) {
        e.stopPropagation();
        showLightbox(-1);
      });
    }

    if (btnNext) {
      btnNext.addEventListener('click', function(e) {
        e.stopPropagation();
        showLightbox(1);
      });
    }

    if (btnClose) {
      btnClose.addEventListener('click', function(e) {
        e.stopPropagation();
        closeLightbox();
      });
    }

    if (lightbox) {
      lightbox.addEventListener('click', function(e) {
        if (e.target === lightbox) {
          closeLightbox();
        }
      });
    }

    document.addEventListener('keydown', function(e) {
      var tag = e.target.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }

      if (lightboxOpen) {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeLightbox();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          showLightbox(-1);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          showLightbox(1);
        }
        return;
      }

      if (e.key === 'ArrowLeft') {
        if (activeStrip) {
          e.preventDefault();
          var state = stripStates.get(activeStrip);
          var targetIndex = state ? state.currentIndex - 1 : 0;
          scrollStripToIndex(activeStrip, targetIndex);
        }
      } else if (e.key === 'ArrowRight') {
        if (activeStrip) {
          e.preventDefault();
          var stateNext = stripStates.get(activeStrip);
          var target = stateNext ? stateNext.currentIndex + 1 : 0;
          scrollStripToIndex(activeStrip, target);
        }
      }
    });
  })();
</script>
