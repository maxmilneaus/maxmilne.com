---
layout: default
---

<article class="photo-essay">
  <div class="photo-essay-header">
    <h1>{{ page.title }}</h1>
    {% if page.date %}
    <time datetime="{{ page.date | date_to_xmlschema }}">{{ page.date | date: "%B %Y" }}</time>
    {% endif %}

    {%- comment -%}
      Authoring model (2025-11-10):
      - Front matter: title, date, tags, excerpt, etc.
      - Body:
        - Leading paragraphs before the first image = intro.
        - Contiguous run of blocks from the first image through the last image
          (including any inline narrative tiles) = film strip.
        - Trailing paragraphs after the final image = closing narrative.
    {%- endcomment -%}

    {%- assign blocks = content | split:'</p>' -%}
    {%- assign intro_html = '' -%}
    {%- assign strip_html = '' -%}
    {%- assign closing_html = '' -%}
    {%- assign state = 'intro' -%}
    {%- assign last_image_index = -1 -%}

    {%- comment -%}
      First pass: detect the index of the last block that contains an image.
    {%- endcomment -%}
    {%- for raw in blocks -%}
      {%- assign block = raw | append: '</p>' -%}
      {%- assign trimmed = block | strip -%}
      {%- if trimmed != '</p>' and trimmed contains '<img ' -%}
        {%- assign last_image_index = forloop.index0 -%}
      {%- endif -%}
    {%- endfor -%}

    {%- comment -%}
      Second pass: partition into intro / strip / closing using last_image_index.
      - If last_image_index == -1 â†’ no images: everything is intro, strip/closing empty.
    {%- endcomment -%}
    {%- if last_image_index == -1 -%}
      {%- assign intro_html = content -%}
      {%- assign strip_html = '' -%}
      {%- assign closing_html = '' -%}
    {%- else -%}
      {%- for raw in blocks -%}
        {%- assign block = raw | append: '</p>' -%}
        {%- assign trimmed = block | strip -%}
        {%- if trimmed == '</p>' -%}
          {%- continue -%}
        {%- endif -%}

        {%- if forloop.index0 <= last_image_index -%}
          {%- if state == 'intro' -%}
            {%- if trimmed contains '<img ' -%}
              {%- assign state = 'strip' -%}
              {%- assign strip_html = strip_html | append: block -%}
            {%- else -%}
              {%- assign intro_html = intro_html | append: block -%}
            {%- endif -%}
          {%- else -%}
            {%- assign strip_html = strip_html | append: block -%}
          {%- endif -%}
        {%- else -%}
          {%- assign closing_html = closing_html | append: block -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if intro_html != '' -%}
    <div class="photo-essay-intro">
      {{ intro_html }}
    </div>
    {%- endif -%}
  </div>

  <div class="photo-strip-container">
    <div class="photo-strip" id="photoStrip">
      {{ strip_html }}
    </div>
  </div>

  {%- if closing_html != '' -%}
  <div class="photo-essay-closing">
    {{ closing_html }}
  </div>
  {%- endif -%}

  <!-- Fullscreen lightbox overlay for photo-strip images -->
  <div class="photo-lightbox" id="photoLightbox" aria-hidden="true">
    <div class="photo-lightbox-inner">
      <div class="photo-lightbox-arrow photo-lightbox-arrow--prev" data-direction="prev" aria-label="Previous image">
        &#10094;
      </div>
      <img id="photoLightboxImage" alt="">
      <div class="photo-lightbox-arrow photo-lightbox-arrow--next" data-direction="next" aria-label="Next image">
        &#10095;
      </div>
      <div class="photo-lightbox-close" id="photoLightboxClose" aria-label="Close">&times;</div>
    </div>
  </div>
</article>

<script>
  (function() {
    const strip = document.getElementById('photoStrip');
    const hint = document.getElementById('scrollHint');
    const lightbox = document.getElementById('photoLightbox');
    const lightboxImg = document.getElementById('photoLightboxImage');
    const lightboxClose = document.getElementById('photoLightboxClose');
    const arrowPrev = lightbox ? lightbox.querySelector('.photo-lightbox-arrow--prev') : null;
    const arrowNext = lightbox ? lightbox.querySelector('.photo-lightbox-arrow--next') : null;

    if (!strip) return;

    // Collect images that belong to the film strip only.
    // Defensive: even though intro/closing are rendered outside #photoStrip,
    // we explicitly constrain to that container so narrative text never becomes a slide.
    const images = Array.prototype.slice.call(
      strip.querySelectorAll('img')
    );

    images.forEach(function(img, index) {
      img.dataset.index = String(index);
    });

    function getSlideWidth(targetImg) {
      if (!targetImg) return 0;
      var parentSlide = targetImg.closest('figure, p, .photo-strip-text');
      var node = parentSlide || targetImg;
      var rect = node.getBoundingClientRect();
      return rect ? rect.width || 0 : 0;
    }

    function updateStripSpacers() {
      if (!strip) return;

      if (window.innerWidth < 769) {
        strip.style.removeProperty('--photo-strip-before');
        strip.style.removeProperty('--photo-strip-after');
        return;
      }

      var firstImg = images[0];
      if (!firstImg) return;
      var lastImg = images[images.length - 1] || firstImg;

      var firstWidth = getSlideWidth(firstImg);
      var lastWidth = getSlideWidth(lastImg);
      var stripStyles = window.getComputedStyle(strip);
      var paddingLeft = parseFloat(stripStyles.paddingLeft) || 0;
      var paddingRight = parseFloat(stripStyles.paddingRight) || 0;
      var viewportWidth = window.innerWidth;

      if (firstWidth > 0) {
        var beforeValue = Math.max(0, (viewportWidth - firstWidth) / 2 - paddingLeft);
        if (isFinite(beforeValue)) {
          strip.style.setProperty('--photo-strip-before', beforeValue + 'px');
        }
      }

      if (lastWidth > 0) {
        var afterValue = Math.max(0, (viewportWidth - lastWidth) / 2 - paddingRight);
        if (isFinite(afterValue)) {
          strip.style.setProperty('--photo-strip-after', afterValue + 'px');
        }
      }
    }

    var spacerRaf = null;
    function scheduleSpacerUpdate() {
      if (spacerRaf) {
        cancelAnimationFrame(spacerRaf);
      }
      spacerRaf = requestAnimationFrame(function() {
        spacerRaf = null;
        updateStripSpacers();
      });
    }

    scheduleSpacerUpdate();
    window.addEventListener('resize', scheduleSpacerUpdate);
    window.addEventListener('load', scheduleSpacerUpdate);

    images.forEach(function(img) {
      if (!img.complete) {
        img.addEventListener('load', scheduleSpacerUpdate);
      }
    });

    // Hide scroll hint after user starts scrolling
    if (hint) {
      let hasScrolled = false;

      strip.addEventListener('scroll', function() {
        if (!hasScrolled && strip.scrollLeft > 20) {
          hasScrolled = true;
          hint.style.opacity = '0';
          setTimeout(function() {
            hint.style.display = 'none';
          }, 300);
        }
      });
    }

    var isLightboxOpen = false;
    var currentIndex = 0;

    function openLightbox(index) {
      if (!lightbox || !images[index]) return;
      currentIndex = index;

      var img = images[index];
      lightboxImg.src = img.getAttribute('data-full-src') || img.src;
      lightboxImg.alt = img.alt || '';
      lightbox.classList.add('is-active');
      lightbox.setAttribute('aria-hidden', 'false');
      isLightboxOpen = true;
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      if (!lightbox || !isLightboxOpen) return;
      lightbox.classList.remove('is-active');
      lightbox.setAttribute('aria-hidden', 'true');
      isLightboxOpen = false;
      document.body.style.overflow = '';
    }

    function showNext(delta) {
      if (!isLightboxOpen || images.length === 0) return;
      currentIndex = (currentIndex + delta + images.length) % images.length;
      openLightbox(currentIndex);
    }

    // Click to open lightbox from strip
    images.forEach(function(img) {
      img.addEventListener('click', function(e) {
        e.preventDefault();
        var index = parseInt(img.dataset.index || '0', 10);
        currentStripIndex = index;
        openLightbox(index);
      });
    });

    // Arrow buttons inside lightbox
    if (arrowPrev) {
      arrowPrev.addEventListener('click', function(e) {
        e.stopPropagation();
        showNext(-1);
      });
    }
    if (arrowNext) {
      arrowNext.addEventListener('click', function(e) {
        e.stopPropagation();
        showNext(1);
      });
    }

    // Close button
    if (lightboxClose) {
      lightboxClose.addEventListener('click', function(e) {
        e.stopPropagation();
        closeLightbox();
      });
    }

    // Click on dark background closes; ignore clicks on inner content
    if (lightbox) {
      lightbox.addEventListener('click', function(e) {
        if (e.target === lightbox) {
          closeLightbox();
        }
      });
    }

    // Mobile tap-to-advance: tap on image advances to next
    if (lightboxImg) {
      lightboxImg.addEventListener('click', function(e) {
        // Only on mobile (touch devices)
        if (window.innerWidth <= 768) {
          e.stopPropagation();
          showNext(1);
        }
      });
    }

    // Track current visible image for keyboard navigation
    var currentStripIndex = 0;

    function scrollToCurrentImage() {
      var targetImg = images[currentStripIndex];
      if (targetImg) {
        targetImg.scrollIntoView({ block: 'nearest', inline: 'center' });
      }
    }

    var syncRaf = null;
    function syncCurrentIndexToViewport() {
      if (!images.length || !strip) return;

      var stripRect = strip.getBoundingClientRect();
      var stripCenterX = stripRect.left + stripRect.width / 2;
      var closestIndex = currentStripIndex;
      var smallestDelta = Infinity;

      images.forEach(function(img, index) {
        var rect = img.getBoundingClientRect();
        var imageCenterX = rect.left + rect.width / 2;
        var delta = Math.abs(imageCenterX - stripCenterX);
        if (delta < smallestDelta) {
          smallestDelta = delta;
          closestIndex = index;
        }
      });

      currentStripIndex = closestIndex;
    }

    if (strip) {
      strip.addEventListener('scroll', function() {
        if (syncRaf) {
          cancelAnimationFrame(syncRaf);
        }
        syncRaf = requestAnimationFrame(syncCurrentIndexToViewport);
      });
    }

    syncCurrentIndexToViewport();

    // Keyboard handling:
    // - When lightbox closed: left/right scroll the strip to next/prev image
    // - When lightbox open: left/right navigate images, Esc closes
    document.addEventListener('keydown', function(e) {
      // Ignore when typing
      var tag = e.target.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA' || e.target.isContentEditable) {
        return;
      }

      if (isLightboxOpen) {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeLightbox();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          showNext(-1);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          showNext(1);
        }
        return;
      }

      // Lightbox not open: navigate to specific images using scroll-snap
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        if (currentStripIndex > 0) {
          currentStripIndex--;
        }
        scrollToCurrentImage();
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        if (currentStripIndex < images.length - 1) {
          // Advance to next image and center it
          currentStripIndex++;
        }
        scrollToCurrentImage();
      }
    });
  })();
</script>
